pipeline {
  agent any


  environment {
    IMAGE_NAME = 'spacehz/jenkins-flask-app'
    IMAGE_TAG  = "${IMAGE_NAME}:${env.GIT_COMMIT}"
    KUBECONFIG = credentials('kubeconfig-creds-id')
  }

  stages {

    stage('Checkout') {

      steps {
        git url: 'https://github.com/spacehz/jenkins-project', branch: 'main'
        sh 'ls -ltr'
        sh 'pwd'
        echo "Build: ${env.BUILD_NUMBER} on executor ${env.EXECUTOR_NUMBER}"
        echo "Commit: ${env.GIT_COMMIT}"
      }
    }

    stage('Setup') {
      steps {
          sh '''
            python3 -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          '''
      }
    }

    stage('Test') {
      steps {
          sh '''
            . venv/bin/activate
            pytest
            whoami
          '''
      }
    }

    stage('Login to Docker Hub') {
      steps {
          withCredentials([
            usernamePassword(
              credentialsId: 'docker-creds',
              usernameVariable: 'USERNAME',
              passwordVariable: 'PASSWORD'
            )
          ]) {
            sh 'echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin'
            echo 'Docker login successful'
          }       
      }
    }

    stage('Build Docker Image') {
      steps {
          sh 'docker build -t $IMAGE_TAG .'
          sh 'docker images'
      }
    }

    // stage('Push Docker Image') {
    //   steps {
    //       sh 'docker push $IMAGE_TAG'
    //       echo 'Docker image pushed successfully'
    //   }
    // }
    stage('Deploy to staging') {
       agent {
        docker {
          image 'bitnami/kubectl:latest'
          args '--entrypoint=""' 
        }
      }
      steps {
          // withCredentials([file(credentialsId: 'kubeconfig-creds-id', variable: 'KUBECONFIG')]) {
          //     sh 'export KUBECONFIG=$KUBECONFIG'
          //     sh 'kubectl version --client'
          //     sh 'echo $KUBECONFIG'
          // }
          sh '''
          // ls -la $KUBECONFIG
          // kubectl set image deployment/flask-app-deployment flask-app=$IMAGE_TAG --kubeconfig=$KUBECONFIG -n staging
          kubectl get ns
          '''
      }
    }

    
      stage('Acceptance Test')
        {
            steps {

                script {

                    // def service = sh(script: "kubectl get svc flask-app-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}:{.spec.ports[0].port}'", returnStdout: true).trim()
                    // echo "${service}"

                    // sh "k6 run -e SERVICE=${service} acceptance-test.js"
                    sh "k6 run acceptance-test.js"
                }
            }
        }

    // stage('Deploy to EKS Cluster') { // steps { // sh "kubectl apply -f deployment.yaml" // echo "Deployed to EKS Cluster" // } // }

  }
}
