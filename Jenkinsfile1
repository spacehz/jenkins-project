pipeline {
  agent {
//     kubernetes {
//       yaml '''
// apiVersion: v1
// kind: Pod
// spec:
//   containers:
//   - name: python
//     image: python:3.11-slim
//     command:
//     - cat
//     tty: true

//   - name: kaniko
//     image: gcr.io/kaniko-project/executor:latest
//     command:
//     - sleep
//     args:
//     - "infinity"
//     tty: true
// '''
//     }
    any

  }

  environment {
    IMAGE_NAME = 'spacehz/jenkins-flask-app'
    IMAGE_TAG  = "${IMAGE_NAME}:${env.GIT_COMMIT}"
  }

  stages {

    stage('Checkout') {

      steps {
        git url: 'https://github.com/spacehz/jenkins-project', branch: 'main'
        sh 'ls -ltr'
        sh 'pwd'
        echo "Build: ${env.BUILD_NUMBER} on executor ${env.EXECUTOR_NUMBER}"
        echo "Commit: ${env.GIT_COMMIT}"
      }
    }

    stage('Setup') {
      steps {
          sh '''
            python3 -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          '''
      }
    }

    stage('Test') {
      steps {
          sh '''
            . venv/bin/activate
            pytest
            whoami
          '''
      }
    }

    stage('Login to Docker Hub') {
      steps {
          withCredentials([
            usernamePassword(
              credentialsId: 'docker-creds',
              usernameVariable: 'USERNAME',
              passwordVariable: 'PASSWORD'
            )
          ]) {
            sh 'echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin'
            echo 'Docker login successful'
          }       
      }
    }

    stage('Build Docker Image') {
      steps {
          sh 'docker build -t $IMAGE_TAG .'
          sh 'docker images'
      }
    }

    stage('Push Docker Image') {
      steps {
          sh 'docker push $IMAGE_TAG'
          echo 'Docker image pushed successfully'
      }
    }

    // stage('Deploy to EKS Cluster') { // steps { // sh "kubectl apply -f deployment.yaml" // echo "Deployed to EKS Cluster" // } // }

  }
}
